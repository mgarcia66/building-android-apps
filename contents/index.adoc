= Building Android Apps

Android applications (known colloquially as _apps_) use Gradle as their build tool, typically through Android Studio. This guide focuses on the Gradle build files generated when creating a new Android application and how to execute the build.

== What you'll build

You'll create a hello-world Android application, explore its generated Gradle build files, and execute common build tasks.

== What you'll need

* About +++<span class="time-to-complete-text"></span>+++
* Android Studio, version 2.4 or higher. You can download Android Studio, along with the latest Android SDK, from https://developer.android.com/studio/index.html . The system requirements for the IDE are also found at that link.
* The Java Development Kit (JDK), version 1.7 or higher

== Create a new Android Studio project

After downloading and installing Android Studio, start the application. On the welcome screen, click the link "Start a new Android Studio project", as shown in the figure. When ready, click _Next_.

// This role renders the figure with a border
[.thumb]
image::Welcome-to-Android-Studio.png[]

On the "Create Android Project" screen, set the application name to "HelloWorldGradle", the company domain to your own (the domain _gradle.org_ is used in the accompanying figure), and select any convenient directory for the project location. Then click _Next_.

[.thumb]
image::Create-New-Project.png[]

On the "Target Android Devices" screen, select _Phone and Tablet_ and choose any recent API level from the _Minimum SDK_ drop-down list. The figure shows API 19, which is common, but the value you choose will not affect the rest of this guide.

[.thumb]
image::Target-Android-Devices.png[]

Once you've selected the API level you want, click on _Next_. On the "Add an Activity" screen that follows, select _Empty Activity_ and click _Next_.

Accept all the defaults on the "Configure Activity" screen and click _Finish_ (or _Next_ if _Finished_ is disabled — you can click _Finished_ on the next screen).

[.thumb]
image::Configure-Activity.png[]

NOTE: The IDE may tell you to install some build tools. Follow the instructions it provides to do so.

== Review the list of generated Gradle files

By default, Android Studio will start with a project view open on the left-hand side, as shown in this figure:

[.thumb]
image::Project-View-Android.png[]

Android projects are multi-project Gradle builds that have a top-level `build.gradle` file in the root directory and a subdirectory called `app`, which has its own `build.gradle` file. You'll see both of them if you open the "Gradle Scripts" node. The top-level build file will be annotated with `(Project: HelloWorldGradle)`  and the `app` build file will have `(Module: app)` next to it. You can see this in the figure above.

There may be two files called `gradle.properties`. One is local to the project and you can see it in the figure above. The other, optional file of the same name resides at `$USER_HOME/.gradle/gradle.properties`, where `$USER_HOME` represents your system home directory. This is a global properties file that applies to _all_ your Gradle builds.

The file `settings.gradle` is used by Gradle to configure the multi-project build. It should consist of a single line:

[source,groovy]
----
include ':app'
----

This tells Gradle that the `app` sub-directory is also a Gradle project. If, at some later time, you were to add an Android Library to this project through the available wizard, another project sub-directory would be created and included by this file.

You can also specify the name of the project in this file, which we recommend. Otherwise Gradle infers the name of the project from the name of its root directory. So update `settings.gradle` to match this:

[source,groovy]
----
include ':app'

rootProject.name = 'HelloWorldGradle'
----

The last file is called `gradle-wrapper.properties`, which configures the {user-manual}gradle_wrapper.html[Gradle Wrapper]. This allows you to build Android projects without having to install Gradle first and it also helps make the build more robust because it is always run with the same version of Gradle, no matter who runs it.

The contents of the file should be similar to the following:

[source,groovy]
----
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-4.1-all.zip
----

The first four lines indicate that when the wrapper runs the first time, it will download a Gradle distribution and store it in the directory `$USER_HOME/.gradle/wrapper/dists`.

The last line shows the value of `distributionUrl`, which is the location from where Gradle will download the distribution.

NOTE: The specific version number might differ from that shown here (4.1), and the URL might refer to a binary version (`-bin`) instead of the complete (`-all`) version shown in this example.

== Review the top-level Gradle build file

The root `build.gradle` file — annotated with `(Project: HelloWorldGradle)` — should have contents similar to this:

[source,groovy]
----
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {  // <1>
    repositories {
        google()
        jcenter()
    }
    dependencies {            
        classpath 'com.android.tools.build:gradle:3.0.1'  // <2>

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {  // <3>
    repositories {
        google()
        jcenter()
    }
}

task clean(type: Delete) {  // <4>
    delete rootProject.buildDir
}
----
<1> Configures dependencies required by the build itself
<2> Specifies the Android plugin as a dependency, using the syntax `<group>:<name>:<version>`
<3> Configures the root project and all module projects
<4> Defines an ad-hoc task to perform a "clean", i.e. delete all the generated build artifacts

NOTE: The Android plugin is updated frequently, so please use the latest plugin when possible to ensure you have all available bug fixes and performance improvements.

When Gradle builds this project for the first time, it will download and cache the plugin. Future runs of the build will use the cached plugin.

The `allprojects {}` block applies configuration to both the root project and any module projects (which are subprojects of the root project). In this case, the block specifies that any required dependencies should be downloaded from Google's repository or JCenter, the public Bintray artifact repository at https://jcenter.bintray.com.

Finally, the build script contains a custom ad-hoc task called `clean`. It uses the built-in task type `Delete` and configures it so that the `clean` task will delete the `buildDir` of the root project. By default, `buildDir` points to the `build` directory in the project directory.

== Review the build script in the app module

Open `build.gradle` in the `app` module and you will see that the first line is

[source,groovy]
----
apply plugin: 'com.android.application'
----

This applies the Android plugin — referred to in the `buildscript` section of the top-level build file — to the current project. Gradle plugins can do anything a build script can, including:

* Defining custom tasks
* Adding new dependency configurations,
* Adding dependencies
 
The Android plugin does all of this and more. Fortunately, the plugin also provides a DSL for configuring the plugin via the `android {}` block, as shown here:

[source,groovy]
----
android {
    compileSdkVersion 26
    defaultConfig {
        applicationId "org.gradle.helloworldgradle"
        minSdkVersion 19
        targetSdkVersion 26
        versionCode 1
        versionName "1.0"
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
----

These properties are more relevant to Android than the Gradle build system, so we will only lightly review them here. In short:

* The `compileSdkVersion` relates to the Android SDK and should always be the latest available version.
* The `defaultConfig` section holds properties that are shared by all variants (combinations of build types and product flavors) of the app.
* The `applicationId` is based on the domain name and project name specified when creating the app, and must be unique in the Google Play store.
* The value of `minSdkVersion` is the minimum Android API you are willing to support with this app, and the `targetSdkVersion` should be the latest Android version available.
* The value of `versionCode` should be an integer that is incremented before uploading a new version of the app into the Google Play store. This value, along with the `applicationId`, tell Google that this is a new version of an existing app, as opposed to a new app.
* The `versionName` value is used for your own internal version tracking.
* The `testInstrumentationRunner` property is configured to use the JUnit 4 test runner configured for Android apps.

You'll also see a `buildTypes {}` block. By default, Android apps support two build types: `debug` and `release`. This section allows you to configure each however you like. The lack of a `debug {}` block means that the project is using the default settings for that build type.

After the `android {}` block comes the `dependencies {}` block, which declares what libraries the app requires:

[source,groovy]
----
dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation 'com.android.support:appcompat-v7:26.1.0'
    implementation 'com.android.support.constraint:constraint-layout:1.0.2'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.1'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.1'
}
----

Dependencies are a fundamental aspect of Gradle builds. In this case, the `dependencies {}` section shows values for the `implementation`, `testImplementation`, and `androidTestImplementation` configurations.

The `testImplementation` configuration is used when compiling the code in `src/test/java`. In this case, the build only requires JUnit 4 so that the tests can use the associated classes and annotations.

The `androidTestImplementation` configuration applies to Android integration testing. The example adds the Espresso testing library to the project, without the `support-annotations` library in this case. The latter would normally be explicitly declared as a dependency, but it is already included via another dependency. You'll see later in this guide how to find out what version of this library was included and why.

Finally, there are three lines that add dependencies to the `implementation` configuration:

* `fileTree(dir: 'libs', include: ['*.jar'])` is a filesystem-based dependency that adds any JAR files in the `libs` folder to the compile classpath
* `com.android.support:appcompat-v7:26.1.0` adds the Android Compatibility library to the project. This allows you to use the Material design theme and other capabilities in any Android app as old as SDK version 7.
* `com.android.support.constraint:constraint-layout:1.0.2` adds the Android Constraint Layout to the project. This allows you to use the ConstraintLayout layout class in any Android app as old as SDK version 9.

== Build the project

Android Studio provides several ways to build the project. For example, you can select the _Make Project_ menu item under the _Build_ menu. If you open the event log at the bottom of the IDE, you'll see that this executes the `:app:assembleDebug` task in the Gradle build. You can see the files generated by the build if you switch the _Project_ view from "Android" to " "Project", as shown here:

[.thumb]
image::Project-View-With-Debug-APK.png[]

What if you want to build the release version of the app or both together? Then you need to interact more directly with Gradle. Open the _Gradle_ view on the right-hand side of the IDE and you'll see all the different tasks that you can run, as shown here:

[.thumb]
image::Gradle-Tasks-View.png[]

From here, double click on the `build` task highlighted in the figure above. This will do a full build, including assembling both the debug and release APKs, which you'll see in the `app/build/outputs` directory once the build has finished.

The debug APK is the one that will be deployed by default to an emulator or connected device via the _Run_ menu options. If you want to deploy a release APK, you need to create a signing configuration first. That's beyond the scope of this guide, but you can learn about it in the https://developer.android.com/studio/publish/app-signing[Android developer documentation].

== Discover the project's dependencies

Even the most basic Android application depends on libraries to run and managing those dependencies is an important part of maintaining the build. That means it's critical that you can see the build's dependencies, including all the transitive ones. There are several tasks that help with this.

First, you can run `androidDependencies` from the _Gradle_ view, under the "android" node. This will display all the dependencies for all the build's configurations.

To limit the list of dependencies to a specific configuration, you'll need to open up the _Terminal_ view — available at the bottom of the IDE — and run `./gradlew :app:dependencies --configuration <confName>`, as shown here for the `debugCompileClasspath` configuration:

[.thumb]
image::Dependencies-In-Terminal.png[]

You can also approach dependencies from the other direction: which dependencies bring in this particular library that I'm interested in? Gradle provides the `dependencyInsight` task to help answer that question.

Once again from the terminal, run the following command (all on one line).

[listing]
----
$ ./gradlew :app:dependencyInsight --dependency support-annotations --configuration releaseCompileClasspath
:app:dependencyInsight
com.android.support:support-annotations:26.1.0
+--- com.android.support:appcompat-v7:26.1.0
|    \--- releaseCompileClasspath
+--- com.android.support:support-compat:26.1.0
|    +--- com.android.support:support-vector-drawable:26.1.0
|    |    +--- com.android.support:appcompat-v7:26.1.0 (*)
|    |    \--- com.android.support:animated-vector-drawable:26.1.0
|    |         \--- com.android.support:appcompat-v7:26.1.0 (*)
|    +--- com.android.support:support-v4:26.1.0
|    |    \--- com.android.support:appcompat-v7:26.1.0 (*)
|    +--- com.android.support:support-media-compat:26.1.0
|    |    \--- com.android.support:support-v4:26.1.0 (*)
|    +--- com.android.support:support-fragment:26.1.0
|    |    \--- com.android.support:support-v4:26.1.0 (*)
|    +--- com.android.support:support-core-utils:26.1.0
|    |    +--- com.android.support:support-v4:26.1.0 (*)
|    |    \--- com.android.support:support-fragment:26.1.0 (*)
|    \--- com.android.support:support-core-ui:26.1.0
|         +--- com.android.support:animated-vector-drawable:26.1.0 (*)
|         +--- com.android.support:support-v4:26.1.0 (*)
|         \--- com.android.support:support-fragment:26.1.0 (*)
+--- com.android.support:support-core-ui:26.1.0 (*)
+--- com.android.support:support-core-utils:26.1.0 (*)
+--- com.android.support:support-media-compat:26.1.0 (*)
\--- com.android.support:support-vector-drawable:26.1.0 (*)

(*) - dependencies omitted (listed previously)


BUILD SUCCESSFUL
----

TIP: Many Gradle tasks support options, like `--configuration` above. We recommend you use the terminal when you want to run a task with one or more options because there is no better alternative at the time of writing.

You can learn more about adding and troubleshooting dependencies in the https://developer.android.com/studio/build/dependencies[Android developer documentation].

== Publish a build scan

https://gradle.com/build-scans[Build scans] are a persistent, shareable record of what happened when running a build.
They provide deep insights into your build, particularly around performance, the tasks that are executed, and the dependencies.

If you are using Gradle 4.3 or above, you can easily create a build scan by using the `--scan` command line option, i.e. `./gradlew <task> --scan`.
For older Gradle versions, see the https://docs.gradle.com/build-scan-plugin/#getting_set_up[Build Scan Plugin User Manual] on how to enable build scans.

Here's the output you can expect from running a build with the `--scan` option:

----
$ ./gradlew build --scan

...

BUILD SUCCESSFUL in 1s
4 actionable tasks: 4 executed

Do you accept the Gradle Cloud Services license agreement (https://gradle.com/terms-of-service)? [yes, no]
yes
Gradle Cloud Services license agreement accepted.

Publishing build scan...
https://gradle.com/s/carzirlfjwjlo
----

The resulting page will resemble this:

[.thumb]
image::Build-scan-for-HelloWorldGradle.png[width=800]

As an example of the kind of information you can see in the build scan, here's an example of us drilling down into the `appcompat-v7` dependency that's part of the `releaseCompileClasspath` configuration:

[.thumb]
image::Build-scan-dep-support-annotations.png[width=800]

Build scans are a powerful way to analyze your build. For more details, see the guide https://guides.gradle.org/creating-build-scans/[Creating Build Scans] and the https://docs.gradle.com/build-scan-plugin/[Build Scan Plugin User Manual].

== Summary

In this guide, you created an Android app and examined many of the Gradle capabilities that came with it. Specifically, you learned how to:

* Create an Android app using Android Studio
* View the generated project as a Gradle multi-project build
* Add the Android plugin to the top-level Gradle build file
* Interpret the settings added in the `android` section of the app
* Work with the default dependencies added to the app
* Use the _Gradle_ view to execute tasks
* Build the app and see the output APK
* Determine which version of a dependency is being used
* Run a build scan on an Android project

== Next Steps

The https://developer.android.com/studio/intro/[Android developer documentation] provides much more information specific to building Android applications and libraries. You might also be interested in learning more about:

* https://guides.gradle.org/writing-gradle-tasks/[Writing custom Gradle tasks]
* {user-manual}multi_project_builds.html[Multi-project builds]
* {user-manual}introduction_dependency_management.html[Managing dependencies]

include::contribute[repo-path="gradle-guides/building-android-apps"]
